#!/usr/bin/env groovy

node {
    stage("Git Clone"){
    git credentialsId: 'GIT_HUB_CREDENTIALS',url:'https://github.com/berktugsnbck/flask-app.git'
    }
    
    //stage("Docker Build"){
    //sh 'docker build --network=host -t berktugsnbck/flask-app:v${BUILD_NUMBER} .'
    //sh 'docker images'
    //}
    
    //stage("Docker Login"){
    //withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'DOCKER_HUB',
    //usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {

    //sh 'docker login -u $USERNAME -p $PASSWORD'
    //}
    //}
    
    //stage("Docker Push"){
    //sh 'docker push berktugsnbck/flask-app:v${BUILD_NUMBER}'
//}
    

    stage("Kubernetes DEV Deployment"){
        
        script {
            env.DOCKER_BUILD_NUMBER=Jenkins.instance.getItem("buildjob").lastSuccessfulBuild.number
        }
        
        sh 'envsubst < ./Kubernetes/dev/deployment.yaml | kubectl apply -f -'
        sh 'kubectl apply -f ./Kubernetes/dev/service.yaml'
         
      }
    
    //stage("Unit-testing"){
        //steps {
             //sh '''#!/bin/bash
                    // echo '##### Install requirements #####'
                    // pip install --user -r requirements.txt
                    // echo '##### run test.py #####'
                    // python test.py
             //'''         
        //}
    //}
    

}
